<html>
    <head>
        <title>
            BIT-Result Portal
        </title>
        <script src='./static/JS/axios.min.js'></script>
        <link rel="stylesheet" href='./static/CSS/faculty-index.css'>
    </head> 
    <script>
        const courseList = {metaData:{},rows:[]}
        const curInfo = {}
        var user={
            'username': sessionStorage.getItem('username'),
            'token' : sessionStorage.getItem('token')
        }

        async function authenticate(){
            let res = await axios.post('/faculty/authenticate',user)
            if(res.data.error){
                console.log('Authentication error')
            }

        }

        authenticate()
    </script>
    <body>
        <nav class="navbar">
            <div class='nav-left'>
                <div class='app-logo'><img src='./static/images/logo.png' class="medium-icon"></div>
                <div class='app-name'> Bangalore Institute Of Technology </div>
            </div>
            <div class='nav-right'>
                <ul>
                    <li><a href='/faculty/home'>Home</a></li>
                    <li><a href='/faculty/course'>Course</a></li>
                    <li><a href='/faculty/students'>Students</a></li>
                    <li  class='active'><a href='/faculty/update-marks'>Update-Marks</a></li>
                    <li class='nav-userinfo'>
                        <div class="nav-userpic">
                            <img id='userIcon'   src='static/icons/thumnail.png'>
                        </div>
                        <div class='nav-username' id='navBarUsername'>Yashwanth</div>
                    </li>
                </ul>
            </div>   
        </nav>
        <script>
            async function getCourseList(){
                var res = await axios.post('/faculty/course-list',user)
                if(res.data.error){
                    console.log('No Course taught')
                }
                else{
                    for(let i=0; i < res.data.metaData.length ; i++)
                    {
                        courseList.metaData[res.data.metaData[i].name] = i;
                    }
                    courseList.rows = res.data.rows
                    console.log(courseList)
                }
            }
            getCourseList()  
         
            //Main function
            async function updateMarksTable(){
                if(typeof sessionStorage.getItem('COURSE_ID') ==='undefined'){
                    sessionStorage.setItem('COURSE_ID',courseList.rows[0][courseList.metaData['COURSE_ID']])
                    sessionStorage.setItem('SECTION',courseList.rows[0][courseList.metaData['SECTION']])
                    sessionStorage.setItem('DEPT_NAME',courseList.rows[0][courseList.metaData['DEPT_NAME']])
                }
                curInfo.course_id = sessionStorage.getItem('COURSE_ID')
                curInfo.section = sessionStorage.getItem('SECTION')
                curInfo.dept_name = sessionStorage.getItem('DEPT_NAME')
                
                var user = {
                    'username' : sessionStorage.getItem('username'),
                    'token' : sessionStorage.getItem('token'),
                    'course_id' : curInfo.course_id,
                    'dept_name' : curInfo.dept_name,
                    'section' : curInfo.section
                }

                let res = await axios.post('/faculty/get-student-mark',user)
                console.log(res.data)
                if(res.data.error){
                    console.log('error in get student marks ',res.data.type)
                }
                else{
                    let colList = [
                        ['USN',{name:'USN',colSpan:1,rowSpan:2},{tagType:'div'}],
                        ['NAME',{name:'Name',colSpan:1,rowSpan:2},{tagType:'div'}],

                        ['TEST1_MARKS',{name:'Internals-1',colSpan:3,rowSpan:1},{tagType:'div'}],
                        ['TEST1_MARKS',{name:'Test',colSpan:1,rowSpan:1},{tagType:'input'}],
                        ['TEST1_ASSIGNMENT',{name:'Assignment',colSpan:1,rowSpan:1},{tagType:'input'}],
                        ['TEST1',{name:'Total',colSpan:1,rowSpan:1},{tagType:'input',default : -1,formula :'SUM(c3,c4)'}],
                        
                        ['TEST2_MARKS',{name:'Internals-2',colSpan:3,rowSpan:1},{tagType:'div'}],
                        ['TEST2_MARKS',{name:'Test',colSpan:1,rowSpan:1},{tagType:'input'}],
                        ['TEST2_ASSIGNMENT',{name:'Assignment',colSpan:1,rowSpan:1},{tagType:'input'}],
                        ['TEST2',{name:'Total',colSpan:1,rowSpan:1},{tagType:'input',default : -1,formula :'SUM(c6,c7)'}],
                        
                        ['TEST3_MARKS',{name:'Internals-3',colSpan:3,rowSpan:1},{tagType:'div'}],
                        ['TEST3_MARKS',{name:'Test',colSpan:1,rowSpan:1},{tagType:'input'}],
                        ['TEST3_ASSIGNMENT',{name:'Assignment',colSpan:1,rowSpan:1},{tagType:'input'}],
                        ['TEST3',{name:'Total',colSpan:1,rowSpan:1},{tagType:'input',default : -1,formula :'SUM(c9,c10)'}],
                        ['IA_MAR',{name:'Final IA',colSpan:1,rowSpan:2},{tagType:'input',default : -1,formula :'CEIL(AVG(c5,c8,c11))'}]
                    ]


                    rowList = {metaData:{},rows: []}
                    for(let i=0; i < res.data.metaData.length ; i++)
                    {
                        rowList.metaData[res.data.metaData[i].name] = i;
                    }
                    rowList.rows = res.data.rows

                    let table = document.createElement('div')

                    createTable({ primary_col : 'USN'},colList,rowList,table)
                    document.getElementById('root').append(table)
                }
            }
            updateMarksTable()
        </script>
        <div id='root'>
            <style>
                .main-page{
                    width:80%;
                    margin: auto;
                    display: flex;
                    flex-direction: column;
                }
                .table-list{
                    margin:auto;
                    margin-top: 20px;
                   
                    min-width: 80%;
                    max-width:100%;
                    text-align: center;
                    height: fit-content;
                    border-collapse:separate;
                    border-spacing:0;
                    box-shadow: 0px 0px 20px 1px rgba(100, 100, 100, 0.555);
                    
                }
                
                
                .table-list th,td{
                    width: fit-content;
                    margin:2px;
                    border: 1px solid rgb(150, 149, 149);
                }
                .table-list th{
                    width:10px;
                    font-size:16px;
                    padding: 10px;
                    background-color: rgb(209, 209, 209);
                   
                }

                .table-list div{
                    padding: 10px;
                    font-size: 16px;
                }
                .table-list input{
                    border:none;
                    font-size: 16px;
                    
                    max-width: 100px;
                    height:100%;
                    background-color: transparent;
                    outline: none;
                    padding: 10px;
                    text-align: center;

                }
                .table-list input:disabled{
                    color: rgb(19, 19, 19);
                }
                
                .table-list a{
                    width:fit-content;
                    padding:10px;
                    text-decoration: none;
                    color:rgb(28, 28, 122);
                    font-weight: 600;
                }
                .table-list a:hover{
                    color:rgb(168, 32, 14)
                }

                .button-list{
                    padding: 15px;
                    display: flex;
                    margin: auto;
                    max-width: 80%;
                    min-height: 10%;
                    justify-content: end;
                }

                .button-list button{
                    font-size: 20px;
                    font-style: italic;
                    font-weight: 500;;
                    width:100%;
                    padding: 6px;
                    border-radius: 6px;
                    outline: none;
                    border: 1px solid gray;
                    color:white;
                    background-color: rgba(33, 33, 165, 0.938);
                }
                .button-list .save{
                    width:100%;
                    padding: 20px ;
                }
            </style>
            <div class='main-page'>
                <table class="table-list">
                    <tbody>
                        <tr>
                            <th rowspan="2">USN</th>
                            <th rowspan="2">Name</th>
                            <th colspan="3">Internal-1</th>
                            <th colspan="3">Internale-2</th> 
                        </tr>
                        <tr>
                            <th>Test</th>
                            <th>Assignment</th>
                            <th>Total</th>
                            <th>Test</th>
                            <th>Assignment</th>
                            <th>Total</th>
                            
                        </tr>
                        <tr>
                            <td><div>1BI19CS002</div></td>
                            <td><div>Vivekananda</div></td>
                            <td><input type="text" pattern="undefined" value="35"></td>
                            <td><input type="text" pattern="undefined" value="30"></td>
                            <td><input type="text" pattern="undefined" value="35"></td>
                            <td><input type="text" pattern="undefined" value="30"></td>
                            <td><input type="text" pattern="undefined" value="35"></td>
                            <td><input type="text" pattern="undefined" value="30"></td>
                            
                        </tr>
                    </tbody>
                </table>
                <div class='button-list'>
                    <div  class='save'><button>Save</button></div>
                    
                </div>
            </div>
           
            
           
        </div>
        <script>
           
            
            //alist=[[db_attribute_name ,alias{name,rowspan,colspan,isMain},row_html={tagType:'div',pattern:''},callback()],.. ]
            //rlist = {metaData: {}, rows: [[]]}
            //linkCol = { name : col_name,column_pos , keyPos:[],link:'http..'}
            async function createTable(info,alist,rlist,rootEle){
                var colPos = []
                var priColPos  = rlist.metaData[info.primary_col]
                var tempColPos = []
                var table = document.createElement('tbody')
                let headerSize = 1
                let orgColList = []

                let tr = document.createElement('tr')
                let tr2 =  document.createElement('tr')
                for(let i=0; i < alist.length; i++)
                {
                    orgColList.push(alist[i])
                    let th = document.createElement('th')

                    th.colSpan = alist[i][1].colSpan
                    th.rowSpan = alist[i][1].rowSpan    
                    th.innerHTML = alist[i][1].name
                    th.id = alist[i][1].name.toUpperCase()
                    if(alist[i][1].colSpan > 1){
                        count = 0;
                        while(alist[i][1].colSpan > count)
                        {
                            count++

                            let th2 = document.createElement('th')
                            orgColList.push(alist[i+count])
                            th2.id = alist[i][1].name.toUpperCase() + ':' + alist[i+count][1].name.toUpperCase()
                            th2.innerHTML = alist[i+count][1].name
                            if(typeof rlist.metaData[alist[i+count][0]] == 'undefined'){
                                console.log(270,'undefined column')
                                rlist.metaData[alist[i+count][0]] = Object.keys(rlist.metaData).length
                                tempColPos.push({pos:colPos.length,value:alist[i+count][2]})
                            }
                            colPos.push(rlist.metaData[alist[i+count][0]])
                            tr2.append(th2)
                        }
                        
                        alist.splice(i,1)
                        i = i+count
                        i--
                    }
                    else{
                        
                        if(typeof rlist.metaData[alist[i][0]] == 'undefined'){
                            console.log('undefined column')
                            rlist.metaData[alist[i][0]] = Object.keys(rlist.metaData).length
                            tempColPos.push({pos:i,value:alist[i][2]})
                        }
                        colPos.push(rlist.metaData[alist[i][0]])
                    }
                    tr.append(th)
                    
                }
                console.log(213,colPos)
                console.log(214,tempColPos)
                //table += '</tr>'
                table.append(tr)
                if(tr2.childNodes.length > 0){
                    table.append(tr2)
                    headerSize = 2
                }
                    

                for(let i=0 ; i<rlist.rows.length;i++){
                    let tr = document.createElement('tr')
                    tr.id = rlist.rows[i][priColPos]
                    for(let j=0 ; j<colPos.length; j++){
                        let td = document.createElement('td')
                       
                        
                        if(rlist.rows[i][colPos[j]] < -1){
                            rlist.rows[i][colPos[j]] = ''
                        }

                        if(alist[j][2].tagType == 'input'){
                            let input = document.createElement('input')
                
                            if(rlist.rows[i][colPos[j]] == -1){
                                rlist.rows[i][colPos[j]] = 'AB'
                                input.style.color =  'rgb(168, 32, 14)'
                            }

                            input.type = 'text'
                            input.pattern = alist[j][2].pattern

                            input.setAttribute('value' ,rlist.rows[i][colPos[j]])
                            input.addEventListener('input',function(e) {
                                e.preventDefault();
                                if(input.value == '-1')
                                {
                                    input.value = 'AB'
                                    input.style.color = 'red'
                                }
                              
                                rlist.rows[i][colPos[j]] = parseInt(input.value)
                                e.target.parentElement.style.border = "1px solid red"
                                e.target.style.color = 'red'
                                }
                            )
                            td.append(input)
                        }
                        else{
                            let div = document.createElement('div')

                            if(rlist.rows[i][colPos[j]] == -1){
                                rlist.rows[i][colPos[j]] = 'AB'
                                input.style.color =  'rgb(168, 32, 14)'
                            }

                            div.innerHTML = rlist.rows[i][colPos[j]]
                            td.append(div)
                        }
                        
                        tr.append(td)
                        //table += `<td>${rlist.rows[i][colPos[j]]}</td>`
                    }
                    /*
                    if(typeof linkCol !== 'undefined')
                    {
                        let td = document.createElement('td')
                        let a = document.createElement('a')
                        a.href = linkCol.link
                        for(let k=0 ; k<linkCol.keyPos.length ; k++){
                            sessionStorage.setItem(linkCol.keyPos[k],rlist.rows[i][rlist.metaData[linkCol.keyPos[k]]])
                        }
                        a.innerHTML = 'Link'
                        td.append(a)
                        if(linkCol.column_pos == 'first')
                            tr.insertBefore(td,tr.firstChild)
                        else
                            tr.append(td)
                    }*/
            
                    table.append(tr)
                }

                 
                for(let i=0; i < tempColPos.length; i++){ 
                    for(let j=0; j < rlist.rows.length; j++){
                        let tr = table.childNodes[j+headerSize]
                        let depCol = {}
                        rlist.rows[j][colPos[tempColPos[i].pos]]= mathRowOperations(tempColPos[i].value.formula,colPos,rlist.rows[j],depCol)
                        
                        for(k in depCol){
                            tr.childNodes[k].childNodes[0].oninput = function (e){
                                rlist.rows[j][colPos[tempColPos[i].pos]]= mathRowOperations(tempColPos[i].value.formula,colPos,rlist.rows[j],depCol)
                                tr.childNodes[tempColPos[i].pos].childNodes[0].value = rlist.rows[j][colPos[tempColPos[i].pos]];
                                tr.childNodes[tempColPos[i].pos].childNodes[0].dispatchEvent(new Event('input'));
                                tr.childNodes[tempColPos[i].pos].style.border = '1px solid red'
                                tr.childNodes[tempColPos[i].pos].childNodes[0].style.color = 'red'
                            }  
                        }
                        tr.childNodes[tempColPos[i].pos].childNodes[0].value = rlist.rows[j][colPos[tempColPos[i].pos]];
                    }
                }
                
                tableEle = document.createElement('table')
                tableEle.className = 'table-list'
                tableEle.append(table)
                rootEle.append(tableEle)

                tabelOption = document.createElement('div')
                tabelOption.className = 'button-list'
                
                ediv = document.createElement('div')
                exportButton = document.createElement('button')
                exportButton.innerHTML = 'export'
                exportButton.addEventListener('click' ,async function(e){
                    e.preventDefault()
                    exportData(orgColList,rlist)
                })
                ediv.append(exportButton)
                tabelOption.append(ediv)
                rootEle.append(tabelOption)
                
            } 
            
            function mathRowOperations(formula,colPos,values,depCol){
                //formula = 'SUM(10,110,102,100,98)'
                let pat = /[^(]+\([^()]+\)/gi
                x=0
                while(formula !== '#x'){
                    opr = formula.match(pat,1)[0]

                    arg = opr.match(/\(([^()]+)\)/)
                    c = arg[1].split(/\s*,\s*/)
                    //console.log(c)
                    t = 0

                    if(opr.toUpperCase().startsWith('SCALE')){
                        if(c.length != 3) 
                            return 'Argument Error : SCALE() takes three arguments (obtained , out-of, scale-to )'
                        multipler = parseInt(c.pop())
                        total = parseInt(c.pop())
                        if(c[0].toUpperCase().startsWith('C')){
                            col = c[i].match(/[0-9]+/)[0]
                            if(typeof depCol[parseInt(col)-1] == 'undefined')
                                depCol[parseInt(col)-1] = true
                            x = values[colPos[parseInt(col)-1]]
                        }
                        else if(c[0] == '#x') 
                            x = x * multipler / total
                        else
                            x = parseInt(c[0]) * multipler / total
                  
                        formula = formula.replace(pat,"#x")
                        continue
                    }
                    else if(opr.toUpperCase().startsWith('CEIL')){
                        if(c.length != 1){
                            return 'Argument Error : CEIL() takes only one Arugment'
                        }
                        if(c[0].toUpperCase().startsWith('C')){
                            col = c[i].match(/[0-9]+/)[0]
                            if(typeof depCol[parseInt(col)-1] == 'undefined')
                                depCol[parseInt(col)-1] = true
                            x = Math.ceil(values[colPos[parseInt(col)-1]])
                        }
                        else if(c[0] == '#x') 
                            x = Math.ceil(x)
                        else
                            x = Math.ceil(parseInt(c[0]))
                  
                        formula = formula.replace(pat,"#x")
                        continue
                    }

                    for(i in c){
                        if(c[i].toUpperCase().startsWith('C')){
                            col = c[i].match(/[0-9]+/)[0]
                            if(typeof depCol[parseInt(col)-1] == 'undefined')
                                depCol[parseInt(col)-1] = true

                            if(!Number.isNaN(parseInt(values[colPos[parseInt(col)-1]]))){
                                t += values[colPos[parseInt(col)-1]]
                                console.log(374,values[colPos[parseInt(col)-1]])
                            }
                               
                        }
                        else if(c[i] == '#x'){
                            t += x
                            continue
                        }
                        else{
                           t += parseInt(c[i])
                        } 
                    }
                    x = t

                    if(opr.toUpperCase().startsWith('SUM')){
                        formula = formula.replace(pat,"#x")
                    }
                    else if(opr.toUpperCase().startsWith('AVG'))
                    {
                        x = x/c.length
                        formula = formula.replace(pat,"#x")
                    }
                    else{
                        return 'Formula Error'
                    }
                
                }
               
                return x
            }

            function exportData(orgColList,rlist){
                console.log('exporting...')
                console.log(rlist)
                console.log(orgColList)

                var str = ''
                let colPos = []
                for(i=0;i<orgColList.length;i++){
                    
                    if(orgColList[i][1].colSpan > 1){
                        count = 0 
                        while(count < orgColList[i][1].colSpan){
                            count++
                            str += ',' + orgColList[i][1].name + ':' + orgColList[i+count][1].name
                            colPos.push(rlist.metaData[orgColList[i+count][0]])
                        }
                        i = i+count
                    }
                    else{
                        str += ',' + orgColList[i][1].name
                        colPos.push(rlist.metaData[orgColList[i][0]])
                    }
                }
                str = str.substring(1)
                str = `Course: ,${curInfo.course_id},Department: ,${curInfo.dept_name},Section: ,${curInfo.section}` + str
                console.log(str)
                console.log(colPos)

                for(let i=0 ;i <rlist.rows.length ; i++){
                    str += '\n'+ rlist.rows[i][colPos[0]]
                    for(let j=1 ; j< colPos.length ; j++)
                        str += ',' + rlist.rows[i][colPos[j]]
                }
                console.log(str)
                a = document.createElement('a')
                a.href = 'data:text/plain;charset=utf-8,'+encodeURIComponent(str)
                console.log(a.href)
                a.download = `${curInfo.course_id}-${curInfo.dept_name}-${curInfo.section}.csv`
                //a.click()
            }
            
            //temp variable
            let rowList = {data:{}}
            rowList.metaData = {
                'NAME' : 1,
                'USN' : 0,
                'TEST1_MARKS' : 2,
                'TEST1_ASSIGNMENT' : 3,
                'TEST2_MARKS' : 4,
                'TEST2_ASSIGNMENT' : 5,
                'TEST3_MARKS' : 6,
                'TEST3_ASSIGNMENT' : 7
            }
           rowList.rows = [
                ['1BI19CS038','BharaTh',25,10,30,10,30,10],
                ['1BI19CS058','Harish',25,10,30,10,30,10],
                ['1BI19CS161','Girsih',25,-1,30,10,30,10],
                ['1BI19CS185','Yashwanth',25,-3,30,10,30,10],
            ]

            let tableInfo = {
                primary_col : 'USN',
                //name
            }

            curInfo.course_id = '18CS54',
            curInfo.section = 'A',
            curInfo.dept_name = 'CSE'
            

            let colList = [
                        ['USN',{name:'USN',colSpan:1,rowSpan:2},{tagType:'div'}],
                        ['NAME',{name:'Name',colSpan:1,rowSpan:2},{tagType:'div'}],

                        ['TEST1_MARKS',{name:'Internals-1',colSpan:3,rowSpan:1},{tagType:'div'}],
                        ['TEST1_MARKS',{name:'Test',colSpan:1,rowSpan:1},{tagType:'input'}],
                        ['TEST1_ASSIGNMENT',{name:'Assignment',colSpan:1,rowSpan:1},{tagType:'input'}],
                        ['TEST1',{name:'Total',colSpan:1,rowSpan:1},{tagType:'input',default : -1,formula :'SUM(c3,c4)'}],
                        
                        ['TEST2_MARKS',{name:'Internals-2',colSpan:3,rowSpan:1},{tagType:'div'}],
                        ['TEST2_MARKS',{name:'Test',colSpan:1,rowSpan:1},{tagType:'input'}],
                        ['TEST2_ASSIGNMENT',{name:'Assignment',colSpan:1,rowSpan:1},{tagType:'input'}],
                        ['TEST2',{name:'Total',colSpan:1,rowSpan:1},{tagType:'input',default : -1,formula :'SUM(c6,c7)'}],
                        
                        ['TEST3_MARKS',{name:'Internals-3',colSpan:3,rowSpan:1},{tagType:'div'}],
                        ['TEST3_MARKS',{name:'Test',colSpan:1,rowSpan:1},{tagType:'input'}],
                        ['TEST3_ASSIGNMENT',{name:'Assignment',colSpan:1,rowSpan:1},{tagType:'input'}],
                        ['TEST3',{name:'Total',colSpan:1,rowSpan:1},{tagType:'input',default : -1,formula :'SUM(c9,c10)'}],
                        ['FINAL IA',{name:'Final IA',colSpan:1,rowSpan:2},{tagType:'input',default : -1,formula :'CEIL(AVG(c5,c8,c11))'}]
                    ]

                  
            let div = document.createElement('div')

            createTable(tableInfo,colList,rowList,div)

            document.getElementById('root').append(div)

        </script>
    </body>
</html>